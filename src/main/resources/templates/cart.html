<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Корзина</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments :: header}"></div>

<main class="container mt-4">
    <h1 class="mb-4">Ваша корзина</h1>
    <div id="cart-items-container">
    </div>
    <div id="cart-total" class="mt-4 fs-4 fw-bold"></div>
    <button id="checkout-button" class="btn btn-success btn-lg mt-3" style="display: none;" onclick="checkout()">Оформить заказ</button>
</main>

<script>
    document.addEventListener('DOMContentLoaded', loadCart);

    function loadCart() {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            document.getElementById('cart-items-container').innerHTML = '<p>Пожалуйста, <a href="/login">войдите</a>, чтобы просмотреть корзину.</p>';
            return;
        }

        fetch('/api/cart', {
            headers: { 'Authorization': 'Bearer ' + token }
        })
            .then(response => response.json())
            .then(items => {
                const container = document.getElementById('cart-items-container');
                const checkoutButton = document.getElementById('checkout-button');
                let total = 0;

                if (items.length === 0) {
                    container.innerHTML = '<p class="text-muted">Ваша корзина пуста.</p>';
                    document.getElementById('cart-total').innerHTML = '';
                    checkoutButton.style.display = 'none';
                    return;
                }

                let cartHtml = '<ul class="list-group">';
                items.forEach(item => {
                    total += item.price * item.quantity;
                    cartHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${item.product.name}</h5>
                                <p class="mb-1 text-muted">Цена за шт.: $${item.price.toFixed(2)}</p>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="input-group me-3" style="width: 170px;">
                                    <input type="number" class="form-control" value="${item.quantity}" min="1" max="${item.product.stock + item.quantity}" id="quantity-${item.id}">
                                    <button class="btn btn-outline-primary" type="button" onclick="updateQuantity(${item.id})">Обновить</button>
                                </div>
                                <button class="btn btn-danger" onclick="deleteItem(${item.id})">Удалить</button>
                            </div>
                        </li>
                    `;
                });
                cartHtml += '</ul>';
                container.innerHTML = cartHtml;
                document.getElementById('cart-total').innerHTML = `Итого: $${total.toFixed(2)}`;
                checkoutButton.style.display = 'block';
            });
    }

    function updateQuantity(itemId) {
        const token = localStorage.getItem('jwt_token');
        const newQuantity = document.getElementById('quantity-' + itemId).value;

        if (newQuantity < 1) {
            alert("Количество не может быть меньше 1.");
            return;
        }

        fetch(`/api/cart/items/${itemId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ quantity: newQuantity })
        })
            .then(response => {
                if (!response.ok) throw new Error('Не удалось обновить количество.');
                loadCart(); // Перезагружаем корзину для отображения изменений
            })
            .catch(error => alert(error.message));
    }

    function deleteItem(itemId) {
        if (!confirm('Вы уверены, что хотите удалить этот товар?')) return;

        const token = localStorage.getItem('jwt_token');

        fetch(`/api/cart/items/${itemId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
        })
            .then(response => {
                if (!response.ok) throw new Error('Не удалось удалить товар.');
                loadCart(); // Перезагружаем корзину
            })
            .catch(error => alert(error.message));
    }

    function checkout() {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            alert('Сессия истекла. Пожалуйста, войдите снова.');
            window.location.href = '/login';
            return;
        }

        fetch('/api/orders/cart/checkout', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        })
            .then(response => {
                if (response.ok) {
                    alert('Заказ успешно оформлен!');
                    window.location.href = '/products';
                } else {
                    alert('Не удалось оформить заказ. Корзина может быть пуста.');
                }
            })
    }
</script>
<script th:src="@{/js/main.js}"></script>
</body>
</html>