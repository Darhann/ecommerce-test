<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Товары</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-card { height: 100%; }
        .product-card .card-body { display: flex; flex-direction: column; }
        .product-card .card-text { flex-grow: 1; }
        .product-image { width: 100%; height: 200px; object-fit: contain; margin-bottom: 1rem; }
    </style>
</head>
<body>
<div th:replace="~{fragments :: header}"></div>

<main class="container mt-4">
    <h1 class="mb-4">Каталог товаров</h1>

    <div class="row mb-4 g-3">
        <div class="col-md-8">
            <input type="text" id="search-input" class="form-control" placeholder="Поиск по названию...">
        </div>
        <div class="col-md-4">
            <select id="sort-select" class="form-select">
                <option value="default">Сортировка по умолчанию</option>
                <option value="price,asc">Цена: по возрастанию</option>
                <option value="price,desc">Цена: по убыванию</option>
            </select>
        </div>
    </div>

    <div id="products-container" class="row g-4"></div>

    <nav id="pagination-nav" class="mt-5 d-flex justify-content-center" aria-label="Page navigation">
        <ul class="pagination">
            <li class="page-item" id="prev-page-item">
                <a class="page-link" href="#" onclick="changePage(-1)">Предыдущая</a>
            </li>
            <li class="page-item disabled"><span class="page-link" id="page-info">1 / 1</span></li>
            <li class="page-item" id="next-page-item">
                <a class="page-link" href="#" onclick="changePage(1)">Следующая</a>
            </li>
        </ul>
    </nav>
</main>

<script>
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const productsContainer = document.getElementById('products-container');

    // Отслеживаем текущую страницу и общее количество страниц
    let currentPage = 0;
    let totalPages = 1;

    // Основная функция для загрузки и отображения товаров
    function fetchAndRenderProducts() {
        const searchTerm = searchInput.value;
        const sortValue = sortSelect.value;

        let url = `/api/products?page=${currentPage}&size=9&sort=${sortValue}`;
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }

        productsContainer.innerHTML = '<p class="text-center">Загрузка...</p>';

        fetch(url)
            .then(response => response.json())
            .then(pageData => { // Ответ от сервера теперь это объект Page
                productsContainer.innerHTML = '';
                const products = pageData.content; // Сами товары лежат в поле content
                totalPages = pageData.totalPages;

                if (products.length === 0) {
                    productsContainer.innerHTML = '<p class="text-muted">Товары не найдены.</p>';
                } else {
                    products.forEach(product => {
                        const imageUrl = product.imageUrl ? product.imageUrl : '/images/placeholder.png';
                        productsContainer.innerHTML += `
                                <div class="col-md-4">
                                    <div class="card product-card">
                                        <img src="${imageUrl}" class="card-img-top product-image" alt="${product.name}">
                                        <div class="card-body">
                                            <h5 class="card-title">${product.name}</h5>
                                            <p class="card-text">${product.description}</p>
                                            <p><strong>Цена:</strong> $${product.price}</p>
                                            <p><small class="text-muted" id="stock-${product.id}">На складе: ${product.stock}</small></p>
                                            <button class="btn btn-primary mt-auto" onclick="addToCart(${product.id}, this)">Добавить в корзину</button>
                                        </div>
                                    </div>
                                </div>`;
                    });
                }
                updatePaginationControls(pageData);
            });
    }

    // Новая функция для обновления кнопок пагинации
    function updatePaginationControls(pageData) {
        document.getElementById('page-info').textContent = `${pageData.number + 1} / ${pageData.totalPages}`;

        const prevButton = document.getElementById('prev-page-item');
        const nextButton = document.getElementById('next-page-item');

        pageData.first ? prevButton.classList.add('disabled') : prevButton.classList.remove('disabled');
        pageData.last ? nextButton.classList.add('disabled') : nextButton.classList.remove('disabled');
    }

    // Новая функция для смены страницы
    function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 0 && newPage < totalPages) {
            currentPage = newPage;
            fetchAndRenderProducts();
        }
    }

    // При поиске или сортировке сбрасываем на первую страницу
    function resetAndFetch() {
        currentPage = 0;
        fetchAndRenderProducts();
    }

    searchInput.addEventListener('input', resetAndFetch);
    sortSelect.addEventListener('change', resetAndFetch);

    document.addEventListener('DOMContentLoaded', fetchAndRenderProducts);

    // ... функция addToCart остается без изменений ...
</script>
</body>
</html>